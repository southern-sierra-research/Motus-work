---
title: "motus_signal_by_antenna_comparison"
author: "Patrick D. lorch"
date: "2023-08-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The idea here is to create a list of tag IDs and then for each tag combine detection data at multiple receivers to generate plots of signal strength for each antenna.

*** Make sure you first run the tagme file to update each station database. ***


## Parameters

Each time we run this, we can modify this section for a particular set of tags and stations.

To set up the receiver list, either keep track from running each receiver (necessary to get databased updated) or pick row numbers from the table resulting from printing df.projRecvs.tab

```{r params}
# Project
# California Department of Fish and Wildlife Motus (#446)
# proj.num = 446 # CDFW
proj.num = 247 # SSRS
# proj.num = 9436 # ALF

## Connect to existing project .motus database
proj.sql.motus <- tagme(projRecv = proj.num, new = FALSE, update = FALSE)

# Construct receiver IDs
# To find station indentifiers, use this:
tbl.recvDeps <- tbl(proj.sql.motus, "recvDeps")
df.projRecvs <- tbl.recvDeps %>%
  filter(projectID == proj.num, # Get just project receivers
         status == "active") %>%
  collect() %>%
  as.data.frame() %>%
  mutate(tsStart = as_datetime(tsStart, tz = "UTC", origin = "1970-01-01"),
         tsEnd = as_datetime(tsEnd, tz = "UTC", origin = "1970-01-01"))
df.projRecvs.tab = select(df.projRecvs, c("deployID", "stationID", "stationName", "serno"))
df.projRecvs.tab
# View(df.projRecvs.tab)

# Either define manually, or use row indices. Comment out the other method.
# using = c(1:length(df.projRecvs.tab$serno)) # To get whole list
using = c(2, 4,  7) # Hummus August 7-9, 2023
# using = c(1, 3, 5, 6)
(rec_names = df.projRecvs.tab$stationName[using])
# rec_names = c("Migrant corner", "Canebrake", "MDLT:Frog Spring", "MDLT:Freeman Canyon Spring")
rec_list = as.list(df.projRecvs.tab$serno)[using]
# rec_list = list("CTT-1F618DF06116", "CTT-27532C924059", "CTT-7406F10DF482", "CTT-89E107C9320E")
# We can add other stations from different projects to this list
rec_list = append(rec_list, "CTT-V30B0154E4B7")

# Tags
tag_motus_id = 60762 
tag = "Hummus (60762)"
file_name_prefix = "Yellow-billed Cuckoo Hummus"
(time_range = as.POSIXct(c("2023-08-09", "2023-08-10")))

motusLogout()

```

## List of tables to combine

This list based method works and allows you to define the receivers at the top of the file with 'using'.  It produces a massive dataframe with even 3 complete alltags tables (> 2,000,000 rows), so we filter by either motusTagID (254,000) or time_range or both first.

We add a day to time_range[2] to allow for 1 day time_range. Otherwise, it returns 0 rows.

```{r tables}
rec_pointer_list = lapply(rec_list, tagme, new=F, update = F)
alltags_list = lapply(rec_pointer_list, tbl, "alltags")

# This fails because no method on collect() for lists
# df.alltags_list = alltags_list %>% 
#   collect() %>% 
#   as.data.frame() %>%
#   mutate(ts = as_datetime(ts, tz = "UTC", origin = "1970-01-01"))

# Nothing showed up in some receivers so checking to see if they are up to 
#  date.  They weren't.
#  I reran the tagme for that database file to update it.
# df.alltags_tunnel = alltags_list[[2]] %>%
#   collect() %>%
#   as.data.frame() %>%
#   mutate(ts = as_datetime(ts, tz = "UTC", origin = "1970-01-01"))
# range(df.alltags_tunnel$ts)
# df.alltags_migrant = alltags_list[[1]] %>%
#   collect() %>%
#   as.data.frame() %>%
#   mutate(ts = as_datetime(ts, tz = "UTC", origin = "1970-01-01"))
# range(df.alltags_migrant$ts)

# Function to use in lapply to make a list of actual dataframes
df.tbl.list = function(tbl_list = alltags_list){
  tbl_list %>%
    collect() %>%
    as.data.frame() %>%
    mutate(ts = as_datetime(ts, tz = "UTC", origin = "1970-01-01")) %>%
    filter(motusTagID == tag_motus_id) # %>%
    # filter(ts >= as_datetime(time_range[1]),
    #        ts <= as_datetime(time_range[2]) + 1*24*60*60) # Adding 1 day in seconds
}

df.alltags_list = lapply(alltags_list, df.tbl.list)
# Combine
df.alltags = df.alltags_list %>%
  bind_rows()

```

## Plots

```{r sigplots, echo=FALSE}
# Run from here for plots
# Testing 1 day resulted in 0 records showed that the time_range cannot be 1 day.
# To make this work, we convert to POSIXCt datetime and add the right number of
# seconds.

# (time_range = as.POSIXct(c("2023-08-09", "2023-08-10")))

df.rec_tags = df.alltags %>%
  filter(motusTagID == tag_motus_id,
         ts >= as_datetime(time_range[1]),
         ts <= as_datetime(time_range[2]) + 1*24*60*60)
# (time_range = range(df.rec_tags$ts))
# Create scaling factor for later (between 0-1)
df.rec_tags$sig_scaled = (df.rec_tags$sig
  - max(df.rec_tags$sig)) / 
  (max(df.rec_tags$sig) - min(df.rec_tags$sig))

rec_tags.sig  = df.rec_tags %>% 
  ggplot(aes(x = ts, y = sig, col = as.factor(paste(recvDeployName,
                                                    antBearing, 
                                                    sep = "-")))) +
  theme_bw() + 
  geom_point() + 
  labs(x = "Time of day (UTC)", y = "Signal strength",
       title = tag) +
  scale_color_discrete(name = "Antenna bearing") +
  facet_grid(recvDeployName ~ .)
rec_tags.sig

ggsave(filename = paste(
  file_name_prefix, tag,
  as.character(as.Date(time_range[1])),
  "to",
  as.character(as.Date(time_range[2])),
  ".pdf", sep = "_"),
  device = "pdf",
  width = 8, height = 5,
  units = "in")

ggsave(filename = paste(
  file_name_prefix, tag,
  as.character(as.Date(time_range[1])),
  "to",
  as.character(as.Date(time_range[2])),
  ".jpg", sep = "_"),
  device = "jpg",
  width = 8, height = 5,
  units = "in")

```

